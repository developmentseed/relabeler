<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Relabeler</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js">

    </script>
</head>
<body>
  <button onClick=save type="button" name="button">Save</button>
  <div id="legend">
    <ul id="legend-list"></ul>
  </div>
  <div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q';

fetch('http://localhost:8000/labels.geojson')
  .then(resp => resp.json())
  .then(data => {
    var bbox = turf.bbox(data)
    var classes = data.features[0].properties.label
    var colors = chroma.scale('Set1').colors(classes.length)

    data.features.forEach((feature, i) => {
      feature.id = i
    })

    var legend = document.getElementById('legend-list')
    classes.forEach((cl, i) => {

    })


    var filters = _.flatten(classes.map((cl, i) => {
      return [
        ['==', ['number', ['at', i, ['array', ['get', 'label']]]], 1],
        colors[i]
      ]
    }))
    var fillColors = ['case'].concat(filters).concat(['black'])
    console.log(fillColors);

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v9',
        center: turf.centroid(data).geometry.coordinates,
        zoom: 4
    })
    map.on('load', () => {
      map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]])
      map.addSource('labels', {
        type: 'geojson',
        data
      })
      map.addLayer({
        'id': 'labels',
        'source': 'labels',
        'type': 'fill',
        'paint': {
          'fill-color': fillColors,
          'fill-outline-color': 'white',
          'fill-opacity': 0.5
        }
      })

      map.on('click', 'labels', (e) => {
        const feature = e.features[0]
        const label = JSON.parse(feature.properties.label)
        const newLabel = [label.pop()].concat(label)
        data.features[feature.id].properties.label = newLabel
        map.getSource('labels').setData(data)
      })
    })
  })

function save () {

}

</script>

</body>
</html>

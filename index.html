<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Relabeler</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; font-family: monospace;}
        #map { position:absolute; top:0; bottom:0; width:100%; z-index: 1 !important;}
        #control { position: absolute; z-index: 2; padding: 0 10px 10px; border: 1px solid #eee; margin: 10px; background-color: white; }
        .label { display: inline-block; height: 10px; width: 10px; margin-right: 5px; }
    </style>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="download.js"></script>
</head>
<body>
  <div id="control">
    <h4>Classes</h4>
    <ul id="legend"></ul>
    <h4>Label Opacity</h4>
    <input id="slider" type="range" min=0 max=100 /><br /><br />
    <button onClick=save() type="button" name="button">Save</button>
    <button onClick=reset() type="button" name="button">Reset</button>
  </div>
  <div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q';

fetch('http://localhost:8000/labels.geojson')
  .then(resp => resp.json())
  .then(data => {
    // store the original copy
    const original = _.cloneDeep(data)

    // give every tile an id/index
    data.features.forEach((feature, i) => {
      feature.id = i
    })

    // now define our classes/colors and use them to...
    var classes = data.features[0].properties.label
    var colors = chroma.scale('Set2').colors(10)

    // ...create a legend
    var legend = document.getElementById('legend')
    classes.forEach((cl, i) => {
      var li = document.createElement('li')
      li.innerHTML = `<span class="label" style="background-color:${colors[i % 10]}"></span>
      ${i === 0 ? 'Background' : `Class ${i}`}`
      legend.appendChild(li)
    })

    // ...and map colors
    var filters = _.flatten(classes.map((cl, i) => {
      return [
        ['==', ['number', ['at', i, ['array', ['get', 'label']]]], 1],
        colors[i % 10]
      ]
    }))
    var fillColors = ['case'].concat(filters).concat(['black'])

    // initialize the map
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v9',
        center: turf.centroid(data).geometry.coordinates,
        zoom: 4
    })
    map.on('load', () => {
      var bbox = turf.bbox(data)
      // zoom to the data
      map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]])

      // load the data
      map.addSource('labels', {
        type: 'geojson',
        data
      })

      // show the data
      map.addLayer({
        'id': 'labels',
        'source': 'labels',
        'type': 'fill',
        'paint': {
          'fill-color': fillColors,
          'fill-outline-color': 'white',
          'fill-opacity': 0.5
        }
      })

      // events

      // on click, update the data for that tile and re-render
      map.on('click', 'labels', (e) => {
        console.log(e);
        const feature = e.features[0]
        const label = JSON.parse(feature.properties.label)
        // shift the label by one
        const newLabel = [label.pop()].concat(label)
        data.features[feature.id].properties.label = newLabel
        map.getSource('labels').setData(data)
      })

      // on slider change, update the layer opacity
      var slider = document.getElementById('slider')
      slider.addEventListener('change', (e) => {
        map.setPaintProperty('labels', 'fill-opacity', e.target.valueAsNumber / 100)
      })

      // on save button click, download the GeoJSON
      window.save = () => {
        var file = new File([JSON.stringify(data)], "labels-modified.json", {
          type: "text/json",
        });
        var url = URL.createObjectURL(file)
        multiDownload([url])
      }

      // on reset button click, reset the map source to the original data
      window.reset = () => {
        map.getSource('labels').setData(original)
        data = original
      }
    })
  })

</script>

</body>
</html>
